lxcConfLib: dir:
let
  lib = import <nixpkgs/lib>;
  path = @path@;
  pkgConfig = (import (path + "/lxc/pkg.nix")) lxcConfLib dir;
  # We add a space on the end so we don't get a path with a trailing \n
  mounts = lib.splitString "\n" ((builtins.readFile (path + "/lxc/storeMounts")) + " ");
  # And then we filter it out.
  mounts1 = builtins.filter (mount: mount != " ") mounts;
  conf = lxcConfLib.sequence ((
      map (mount: lxcConfLib.addMountEntry (mount + " " + dir + "/rootfs" + mount + " none ro,bind 0 0")) mounts1
    ) ++ [pkgConfig.conf]);
  onCreate = [(path + "/lxc/onCreate.sh")] ++ (if pkgConfig ? onCreate then pkgConfig.onCreate else []);
in
  pkgConfig // {inherit conf onCreate;}
