#! @shell@ -e

base=/var/lib/lxc
dir=$base/@name@

mkdir -p $dir

[ ! -e $dir/config ] # sterilise will remove this, so this is our test for whether it's been sterilised or not.

mkdir -p $dir/rootfs/sbin
mkdir -p -m 1777 $dir/rootfs/tmp

printf \
'lxc.include = @lxcConfigBase@
lxc.rootfs = %s
lxc.mount = %s
lxc.console = %s' \
       $dir/rootfs $dir/fstab $dir/console \
       > $dir/config

for f in $(cat @storeMounts@); do
    printf '%s %s/rootfs%s none ro,bind 0 0\n' $f $dir $f >> $dir/fstab
    if [ -d "$f" ]; then
      mkdir -p $dir/rootfs$f
    else
      touch $dir/rootfs$f
    fi
done

for f in @onCreate@; do
    $f $dir $dir/config $dir/fstab
done

@coreutils@/bin/ln -s @init@ $dir/rootfs/sbin/init
@coreutils@/bin/ln -s $(@coreutils@/bin/readlink -f "$0") $dir/creator
@coreutils@/bin/ln -s @sterilise@ $dir/sterilise
