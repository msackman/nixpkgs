#! @shell@ -e

createInDir=$1

mkdir $createInDir
mkdir -p $createInDir/rootfs

for d in $(cat @out@/lxc/storeMounts); do
    mkdir -p $createInDir/rootfs/$d
done

for d in proc sys dev tmp sbin; do
    mkdir -p $createInDir/rootfs/$d
done

printf '%s %s %s' '(import @library@).buildLXCconf' '@out@' $createInDir \
  | @nix@/bin/nix-instantiate --eval-only - > $createInDir/lxc.conf

printf '%s %s %s' '(import @library@).buildLXCfstab' '@out@' $createInDir \
  | @nix@/bin/nix-instantiate --eval-only - > $createInDir/fstab

init=$(printf '%s %s' '(import @library@).exec' '@out@' \
  | @nix@/bin/nix-instantiate --eval-only - | @sed@/bin/sed "s/^\([\"']\)\(.*\)\1\$/\2/g")

@coreutils@/bin/ln -s $init $createInDir/rootfs/sbin/init
