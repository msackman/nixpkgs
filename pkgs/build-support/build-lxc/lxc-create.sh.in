#! @shell@ -e

userDir=$1
shift
dir=$(@coreutils@/bin/dirname $userDir)
base=$(@coreutils@/bin/basename $userDir)
createInDir=$dir/$base

mkdir $createInDir
mkdir -p $createInDir/rootfs

for d in tmp sbin; do
    mkdir -p $createInDir/rootfs/$d
done

printf \
'lxc.include = @lxcConfigBase@
lxc.rootfs = %s
lxc.mount = %s' \
       $createInDir/rootfs $createInDir/fstab \
       > $createInDir/lxc.conf

for f in $(cat @storeMounts@); do
    printf '%s %s/rootfs%s none ro,bind 0 0\n' $f $createInDir $f >> $createInDir/fstab
    mkdir -p $createInDir/rootfs$f
done

for f in @onCreate@; do
    $f $createInDir $createInDir/lxc.conf $createInDir/fstab
done

@coreutils@/bin/ln -s @init@ $createInDir/rootfs/sbin/init
